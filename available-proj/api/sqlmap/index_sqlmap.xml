<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="available">
    <select id="available.selectOutput">
        select output_idx, name, price
        from tb_output
    </select>
    
    <insert id="available.insertContent">
        INSERT INTO TB_CONTENT(
            CONTENT, REG_DATE
        )VALUES(
            #{content} , current_timestamp()
        )
    </insert>

    <insert id="available.insertOrder">
        INSERT INTO TB_ORDER(
            TITLE
            , B_TIME
            , E_TIME
            , OUTPUT
            , CONTENT_IDX
            , NOTE
            , IMP_YN
            , DELETE_YN
        )
        VALUES(
            #{title}
            , #{b_time}
            , #{e_time}
            , #{output}
            , #{content_idx}
            , #{note}
            , #{imp_yn}
            , #{delete_yn}
        );
    </insert>

    <insert id="available.insertOrderHis">
        INSERT INTO TB_ORDER_HIS(
            ORDER_IDX
            , TITLE
            , B_TIME
            , E_TIME
            , OUTPUT
            , CONTENT_IDX
            , NOTE
            , IMP_YN
            , DELETE_YN
            , REG_DATE
        )
        VALUES(
            #{order_idx}
            , NULL
            , #{b_time}
            , #{e_time}
            , #{output}
            , #{content_idx}
            , #{note}
            , #{imp_yn}
            , #{delete_yn}
            , CURRENT_TIMESTAMP()
        );
    </insert>

    <insert id="available.insertPrice">
        INSERT INTO TB_PRICE (
            ORDER_IDX,
            ORDER_PRICE,
            WORK_PRICE,
            SHOW_YN
        )
        VALUES(
            #{order_idx},
            #{order_price},
            #{work_price},
            #{show_yn}
        )
    </insert>

    <insert id="available.insertOrderStatus">
        INSERT INTO TB_ORDER_STATUS (
            ORDER_IDX,
            STATUS
        )
        VALUES(
            #{order_idx},
            #{status}
        )
    </insert>

    <select id="available.selectOrderList">
        SELECT 
            A.order_idx,
            A.title,
            DATE_FORMAT(A.b_time, '%Y-%m-%d') AS 'b_time',
            DATE_FORMAT(A.e_time, '%Y-%m-%d') AS 'e_time',
            A.output,
            D.status,
            A.imp_yn,
            C.order_price,
            C.work_price,
            C.show_yn
        FROM TB_ORDER A
        INNER JOIN TB_PRICE C ON A.ORDER_IDX = C.ORDER_IDX 
        INNER JOIN TB_ORDER_STATUS D ON A.ORDER_IDX = D.ORDER_IDX
        where 
            A.delete_yn = 'N'
        ORDER BY 
        <if test="sortData == 'order' or sortData == 'broker'">
            (
                CASE
                    WHEN D.status = '03' THEN 0
                    WHEN D.status = '05' THEN 0
                    WHEN D.status = '04' THEN 2
                    ELSE 1
                END
            ),
        </if>
        <if test="sortData == 'work'">
            (
                CASE
                    WHEN D.status = '01' THEN 0
                    WHEN D.status = '02' THEN 0
                    WHEN D.status = '06' THEN 0
                    WHEN D.status = '04' THEN 2
                    ELSE 1
                END
            ),
        </if>
        A.order_idx DESC
    </select>

    <update id="available.updateOrderStatus">
        UPDATE TB_ORDER_STATUS
        SET STATUS = #{status}
        WHERE ORDER_IDX = #{order_idx}
    </update>
</mapper>